
--(1) List all unique cities where customers are located.

Select distinct(customer_city) as dist_city from dbo.customers;

/* 
(2)Count the number of orders placed in 2017.*/

select count(*) total_orders_2017 from dbo.orders
where year(order_purchase_timestamp)= 2017;

/* (3)Find the total sales per category.*/
select top 10 upper(pr.product_category) as Product_category, round(sum(py.payment_value),2) as total_sales from dbo.products as pr
join dbo.order_items as ort
on ort.product_id = pr.product_id
join dbo.payments as py
on py.order_id = ort.order_id
group by pr.product_category
order by sum(py.payment_value) desc;

/* (4)Calculate the percentage of orders that were paid in installments. */
select (sum(case when payment_installments >=1 then 1 else 0 end)/cast(count(*) as float)*100) as per
from payments;

/*(5) Count the number of customers from each state.*/
select top 10 customer_state,count(*) as Total_customers
from customers
group by customer_state
order by count(*) desc;

/* (6) Calculate the number of orders per month in 2018.*/
select MONTH(order_purchase_timestamp), count(order_id) as total_orders from orders
group by MONTH(order_purchase_timestamp) 
order by MONTH(order_purchase_timestamp) ;

/*
(7) Find the average number of products per order, grouped by customer city.*/\
with count_per_order as 
(select orders.order_id, orders.customer_id, count(order_items.order_id) as oc
from orders join order_items
on orders.order_id = order_items.order_id
group by orders.order_id, orders.customer_id)

select customers.customer_city, round(avg(count_per_order.oc),2) average_orders
from customers join count_per_order
on customers.customer_id = count_per_order.customer_id
group by customers.customer_city order by average_orders desc;

/* (8) Calculate the percentage of total revenue contributed by each product category.*/
select upper(products.product_category) category, 
round((sum(payments.payment_value)/(select sum(payment_value) from payments))*100,2) sales_percentage
from products join order_items 
on products.product_id = order_items.product_id
join payments 
on payments.order_id = order_items.order_id
group by upper(products.product_category) order by sales_percentage desc;

/*(9) Identify the correlation between product price and the number of times a product has been purchased.*/
select products.product_category, 
count(order_items.product_id) as count_pro,
round(avg(order_items.price),2) as avg_ord_price
from products join order_items
on products.product_id = order_items.product_id
group by products.product_category;

/* (10) Calculate the total revenue generated by each seller, and rank them by revenue.*/
select *, dense_rank() over (order by revenue desc) as ranks from (select s.seller_id, sum(p.payment_value) as revenue from sellers as s
join order_items oi
on oi.seller_id = s.seller_id
join payments as p
on p.order_id =  oi.order_id
group by s.seller_id)a;

/* (11) Calculate the moving average of order values for each customer over their order history.*/
select customer_id, order_purchase_timestamp, payment,
avg(payment) over(partition by customer_id order by order_purchase_timestamp
rows between 2 preceding and current row) as mov_avg
from
(select orders.customer_id, orders.order_purchase_timestamp, 
payments.payment_value as payment
from payments join orders
on payments.order_id = orders.order_id) as a;

/* (12) Calculate the cumulative sales per month for each year.*/
select years, months , payment, sum(payment)
over(partition by years order by years, months) cumulative_sales,
sum(payment)
over(partition by years order by years) cumulative_sales_year
from 
(select year(orders.order_purchase_timestamp) as years,
month(orders.order_purchase_timestamp) as months,
round(sum(payments.payment_value),2) as payment from orders join payments
on orders.order_id = payments.order_id
group by year(orders.order_purchase_timestamp), month(orders.order_purchase_timestamp)) as a ;

/* (13) Calculate the year-over-year growth rate of total sales. */
with a as(select year(orders.order_purchase_timestamp) as years,
round(sum(payments.payment_value),2) as payment from orders join payments
on orders.order_id = payments.order_id
group by year(orders.order_purchase_timestamp))

select years,payment,lag(payment, 1) over(order by years) as pre_year, round(((payment - lag(payment, 1) over(order by years))/
lag(payment, 1) over(order by years)) * 100,2) as per_change from a;

/* (14) Calculate the retention rate of customers, 
defined as the percentage of customers who make 
another purchase within 6 months of their first purchase.*/
WITH CustomerFirstPurchase AS (
    -- Identify the very first purchase date for every customer
    SELECT 
        customer_id, 
        MIN(order_purchase_timestamp) AS first_purchase_date
    FROM Orders
    GROUP BY customer_id
),
Repurchasers AS (
    -- Identify customers who bought again within 6 months
    SELECT DISTINCT 
        f.customer_id
    FROM CustomerFirstPurchase f
    JOIN Orders o ON f.customer_id = o.customer_id
    -- Purchase must be after the first one, but within 6 months
    WHERE o.order_purchase_timestamp > f.first_purchase_date 
      AND o.order_purchase_timestamp <= DATEADD(month, 6, f.first_purchase_date)
)
SELECT 
    (CAST(COUNT(r.customer_id) AS FLOAT) / COUNT(f.customer_id)) * 100 AS SixMonthRepurchaseRate
FROM CustomerFirstPurchase f
LEFT JOIN Repurchasers r ON f.customer_id = r.customer_id;

/* (15) Identify the top 3 customers who spent the most money in each year.*/
select * from (select year(order_purchase_timestamp) as years
,customer_id,sum(p.payment_value) as total,dense_rank() over (partition by year(order_purchase_timestamp) order by sum(p.payment_value) desc) as rn from orders as o
join  payments as p
on p.order_id = o.order_id
group by year(o.order_purchase_timestamp),o.customer_id) a
where rn<4;
